<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>알림 - SNS247</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <style>
        :root {
            --primary-color: #1da1f2;
            --secondary-color: #657786;
            --background-color: #f5f8fa;
            --border-color: #e1e8ed;
        }

        body {
            background-color: var(--background-color);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }

        /* 헤더 스타일 */
        .header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background-color: white;
            border-bottom: 1px solid var(--border-color);
            z-index: 1000;
            padding: 10px 0;
        }

        .header-content {
            max-width: 600px;
            margin: 0 auto;
            padding: 0 15px;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        /* 메인 컨텐츠 영역 */
        .main-content {
            max-width: 600px;
            margin: 60px auto 70px;
            background-color: white;
            min-height: calc(100vh - 130px);
        }

        /* 알림 아이템 */
        .notification-item {
            display: flex;
            padding: 15px;
            border-bottom: 1px solid var(--border-color);
            transition: background-color 0.2s;
            text-decoration: none;
            color: inherit;
        }

        .notification-item:hover {
            background-color: var(--background-color);
        }

        .notification-item.unread {
            background-color: #f5f8fa;
        }

        .notification-icon {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            margin-right: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: white;
        }

        .notification-icon.like {
            background-color: #e0245e;
        }

        .notification-icon.comment {
            background-color: #1da1f2;
        }

        .notification-icon.follow {
            background-color: #17bf63;
        }

        .notification-icon.repost {
            background-color: #794bc4;
        }

        .notification-content {
            flex: 1;
        }

        .notification-text {
            margin-bottom: 4px;
            line-height: 1.4;
        }

        .notification-time {
            color: var(--secondary-color);
            font-size: 14px;
        }

        .notification-preview {
            margin-top: 8px;
            padding: 12px;
            background-color: #f8f9fa;
            border-radius: 8px;
            font-size: 14px;
            color: var(--secondary-color);
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .preview-post, .preview-comment {
            display: flex;
            align-items: flex-start;
            gap: 8px;
            padding: 4px 0;
        }

        .preview-post {
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 12px;
            font-size: 13px;
            color: #657786;
        }

        .preview-comment {
            font-size: 15px;
            color: #14171a;
            background-color: white;
            padding: 8px 12px;
            border-radius: 6px;
            border: 1px solid var(--border-color);
        }

        .notification-preview i {
            font-size: 16px;
            color: var(--primary-color);
            margin-top: 2px;
        }

        .preview-post i {
            color: #657786;
        }

        /* 알림 없음 */
        .no-notifications {
            text-align: center;
            padding: 30px;
            color: var(--secondary-color);
        }

        /* 알림 타입별 아이콘 */
        .notification-type-icon {
            font-size: 20px;
            margin-right: 8px;
        }
    </style>
</head>
<body>
    <!-- 헤더 -->
    <div class="header">
        <div class="header-content">
            <h5 class="mb-0">알림</h5>
            <div class="ms-auto position-relative">
                <img src="<%= currentUser.profileImage || '/images/default-profile.png' %>" 
                     alt="프로필" 
                     class="profile-image"
                     style="width: 32px; height: 32px; cursor: pointer;"
                     onclick="toggleProfileDropdown()">
                <%- include('partials/profile-dropdown') %>
            </div>
        </div>
    </div>

    <!-- 메인 컨텐츠 -->
    <div class="main-content">
        <% if (notifications.length === 0) { %>
            <div class="no-notifications">
                <i class="bi bi-bell" style="font-size: 48px; margin-bottom: 15px;"></i>
                <p>아직 알림이 없습니다.</p>
            </div>
        <% } else { %>
            <% notifications.forEach(notification => { %>
                <a href="<%= notification.link %>" 
                   class="notification-item <%= notification.read ? '' : 'unread' %>"
                   data-notification-id="<%= notification.id %>">
                    <div class="notification-icon <%= notification.type %>">
                        <% if (notification.type === 'like') { %>
                            <i class="bi bi-heart-fill"></i>
                        <% } else if (notification.type === 'comment') { %>
                            <i class="bi bi-chat-fill"></i>
                        <% } else if (notification.type === 'follow') { %>
                            <i class="bi bi-person-plus-fill"></i>
                        <% } else if (notification.type === 'repost') { %>
                            <i class="bi bi-repeat"></i>
                        <% } %>
                    </div>
                    <div class="notification-content">
                        <div class="notification-text">
                            <strong><%= notification.sender.name %></strong>
                            <% if (notification.type === 'like') { %>
                                님이 회원님의 게시물을 좋아합니다.
                            <% } else if (notification.type === 'comment') { %>
                                님이 회원님의 게시물에 댓글을 남겼습니다.
                                <% if (notification.preview) { 
                                    let postContent = '';
                                    let commentContent = '';
                                    try {
                                        const preview = JSON.parse(notification.preview);
                                        postContent = preview.postContent;
                                        commentContent = preview.commentContent;
                                    } catch (e) {
                                        // 이전 형식의 데이터 처리
                                        commentContent = notification.preview;
                                    }
                                %>
                                    <div class="notification-preview">
                                        <% if (postContent) { %>
                                            <div class="preview-post">
                                                <i class="bi bi-file-text"></i>
                                                <%= postContent %>
                                            </div>
                                        <% } %>
                                        <div class="preview-comment">
                                            <i class="bi bi-chat-left-text"></i>
                                            <strong><%= commentContent %></strong>
                                        </div>
                                    </div>
                                <% } %>
                            <% } else if (notification.type === 'follow') { %>
                                님이 회원님을 팔로우하기 시작했습니다.
                            <% } else if (notification.type === 'repost') { %>
                                님이 회원님의 게시물을 리포스트했습니다.
                            <% } %>
                        </div>
                        <div class="notification-time">
                            <%= new Date(notification.createdAt).toLocaleString('ko-KR') %>
                        </div>
                    </div>
                </a>
            <% }); %>
        <% } %>
    </div>

    <%- include('partials/navigation') %>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        // Socket.IO 연결 설정
        const socket = io({
            reconnection: true,
            reconnectionDelay: 1000,
            reconnectionDelayMax: 5000,
            reconnectionAttempts: 5
        });

        // 연결 성공 시
        socket.on('connect', () => {
            console.log('Socket.IO connected');
            // 사용자 인증
            socket.emit('authenticate', '<%= currentUser.id %>');
        });

        // 연결 실패 시
        socket.on('connect_error', (error) => {
            console.error('Socket.IO connection error:', error);
        });

        // 재연결 시도 시
        socket.on('reconnecting', (attemptNumber) => {
            console.log('Socket.IO reconnecting...', attemptNumber);
        });

        // 새로운 알림 수신
        socket.on('newNotification', (notification) => {
            console.log('New notification received:', notification);
            
            // 알림 목록의 맨 위에 새 알림 추가
            const notificationsList = document.querySelector('.main-content');
            const noNotifications = document.querySelector('.no-notifications');
            
            if (noNotifications) {
                notificationsList.innerHTML = '';
            }

            const notificationElement = createNotificationElement(notification);
            notificationsList.insertBefore(notificationElement, notificationsList.firstChild);

            // 알림 소리 재생
            playNotificationSound();

            // 알림 배지 업데이트
            updateNotificationBadge();
        });

        // 알림 요소 생성 함수
        function createNotificationElement(notification) {
            const element = document.createElement('a');
            element.href = notification.link;
            element.className = `notification-item unread`;
            element.dataset.notificationId = notification.id;

            let previewHtml = '';
            if (notification.preview) {
                try {
                    const preview = JSON.parse(notification.preview);
                    previewHtml = `
                        <div class="notification-preview">
                            ${preview.postContent ? `
                                <div class="preview-post">
                                    <i class="bi bi-file-text"></i>
                                    ${preview.postContent}
                                </div>
                            ` : ''}
                            <div class="preview-comment">
                                <i class="bi bi-chat-left-text"></i>
                                <strong>${preview.commentContent}</strong>
                            </div>
                        </div>
                    `;
                } catch (e) {
                    previewHtml = `
                        <div class="notification-preview">
                            <div class="preview-comment">
                                <i class="bi bi-chat-left-text"></i>
                                <strong>${notification.preview}</strong>
                            </div>
                        </div>
                    `;
                }
            }

            element.innerHTML = `
                <div class="notification-icon ${notification.type}">
                    ${getNotificationIcon(notification.type)}
                </div>
                <div class="notification-content">
                    <div class="notification-text">
                        <strong>${notification.sender.name}</strong>
                        ${getNotificationText(notification.type)}
                        ${previewHtml}
                    </div>
                    <div class="notification-time">
                        ${new Date(notification.createdAt).toLocaleString('ko-KR')}
                    </div>
                </div>
            `;

            // 알림 클릭 이벤트 처리
            element.addEventListener('click', async function(e) {
                const notificationId = this.dataset.notificationId;
                try {
                    const response = await fetch(`/notifications/${notificationId}/read`, {
                        method: 'POST'
                    });
                    if (response.ok) {
                        this.classList.remove('unread');
                        updateNotificationBadge();
                    }
                } catch (error) {
                    console.error('Error marking notification as read:', error);
                }
            });

            return element;
        }

        // 알림 배지 업데이트 함수
        function updateNotificationBadge() {
            const unreadCount = document.querySelectorAll('.notification-item.unread').length;
            const badge = document.querySelector('.notification-badge');
            if (badge) {
                badge.textContent = unreadCount;
                badge.style.display = unreadCount > 0 ? 'block' : 'none';
            }
        }

        // 알림 타입별 아이콘 반환
        function getNotificationIcon(type) {
            switch (type) {
                case 'like':
                    return '<i class="bi bi-heart-fill"></i>';
                case 'comment':
                    return '<i class="bi bi-chat-fill"></i>';
                case 'follow':
                    return '<i class="bi bi-person-plus-fill"></i>';
                case 'repost':
                    return '<i class="bi bi-repeat"></i>';
                default:
                    return '';
            }
        }

        // 알림 타입별 텍스트 반환
        function getNotificationText(type) {
            switch (type) {
                case 'like':
                    return '님이 회원님의 게시물을 좋아합니다.';
                case 'comment':
                    return '님이 회원님의 게시물에 댓글을 남겼습니다.';
                case 'follow':
                    return '님이 회원님을 팔로우하기 시작했습니다.';
                case 'repost':
                    return '님이 회원님의 게시물을 리포스트했습니다.';
                default:
                    return '';
            }
        }

        // 알림 소리 재생
        function playNotificationSound() {
            const audio = new Audio('/sounds/notification.mp3');
            audio.play().catch(error => {
                console.log('알림 소리를 재생할 수 없습니다:', error);
            });
        }

        // 초기 알림 배지 업데이트
        updateNotificationBadge();
    </script>
</body>
</html> 